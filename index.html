<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GPU Scheduling Visualizer</title>
  <link rel="stylesheet" href="src/viz.css">
</head>
<body>
  <!-- Header -->
  <header id="header">
    <div class="header-left">
      <h1>GPU Scheduling Visualizer</h1>
      <button id="btn-help" class="help-btn" title="About this visualizer">?</button>
    </div>
    <div class="header-controls">
      <div class="playback-controls">
        <button id="btn-first" class="playback-btn" title="First frame">&#x23EE;</button>
        <button id="btn-prev" class="playback-btn" title="Previous frame">&#x23F4;</button>
        <button id="btn-play" class="playback-btn play-btn" title="Play/Pause">&#x25B6;</button>
        <button id="btn-next" class="playback-btn" title="Next frame">&#x23F5;</button>
        <button id="btn-last" class="playback-btn" title="Last frame">&#x23ED;</button>
      </div>
      <div class="speed-selector">
        <label for="speed-select">Speed:</label>
        <select id="speed-select">
          <option value="0.25">0.25x</option>
          <option value="0.5">0.5x</option>
          <option value="1" selected>1x</option>
          <option value="2">2x</option>
          <option value="5">5x</option>
          <option value="10">10x</option>
        </select>
      </div>
    </div>
  </header>

  <!-- Experiment Picker -->
  <section id="exp-browser" class="exp-browser">
    <div class="exp-picker" id="exp-picker-1">
      <div class="exp-picker-row">
        <span class="exp-picker-label">Sim 1</span>
        <select class="exp-picker-select" data-sim="0">
          <option value="">-- select experiment --</option>
        </select>
      </div>
      <div class="exp-picker-tags" data-sim="0"></div>
    </div>
    <div class="exp-picker" id="exp-picker-2">
      <div class="exp-picker-row">
        <span class="exp-picker-label">Sim 2</span>
        <select class="exp-picker-select" data-sim="1">
          <option value="">-- select experiment --</option>
        </select>
      </div>
      <div class="exp-picker-tags" data-sim="1"></div>
    </div>
  </section>

  <!-- Timeline Scrubber -->
  <section id="timeline-section">
    <div class="timeline-container">
      <div class="phase-markers">
        <span class="phase-marker phase-warmup">Warmup</span>
        <span class="phase-marker phase-measurement">Measurement</span>
        <span class="phase-marker phase-cooldown">Cooldown</span>
      </div>
      <input type="range" id="timeline-scrubber" min="0" max="100" value="0" step="1">
      <div class="timeline-labels">
        <span id="timeline-current">0</span>
        <span id="timeline-total">/ 0</span>
      </div>
    </div>
  </section>

  <!-- Tab Bar -->
  <nav id="tab-bar" class="tab-bar" hidden>
    <button class="tab-btn active" data-tab="charts">Charts</button>
    <button class="tab-btn" data-tab="heatmap">Heatmap & Metrics</button>
    <button class="tab-btn" data-tab="results">Results</button>
  </nav>

  <!-- Tab: Charts -->
  <div id="tab-charts" class="tab-content">
    <section id="charts-section" class="sim-section" hidden>
      <div class="charts-header">
        <h2 class="sim-title">Comparison</h2>
        <div class="chart-view-controls">
          <label class="chart-view-option">
            <input type="radio" name="chart-view" value="all" checked> All
          </label>
          <label class="chart-view-option">
            <input type="radio" name="chart-view" value="rolling"> Rolling
          </label>
          <div id="rolling-window-controls" class="rolling-window-controls" hidden>
            <input type="number" id="rolling-window-size" value="100" min="10" max="10000" step="10">
            <span class="rolling-window-unit">rounds</span>
          </div>
          <div class="rolling-window-controls">
            <span class="rolling-window-unit">PDF last</span>
            <input type="number" id="pdf-window-size" value="1000" min="10" max="100000" step="100">
            <span class="rolling-window-unit">jobs</span>
          </div>
        </div>
      </div>
      <div class="charts-row">
        <div class="chart-container">
          <canvas id="chart-utilization" width="570" height="200"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="chart-jct" width="570" height="200"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="chart-queue" width="570" height="200"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="chart-jct-pdf" width="570" height="200"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="chart-fragmentation" width="570" height="200"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="chart-pending" width="570" height="200"></canvas>
        </div>
      </div>
    </section>
  </div>

  <!-- Tab: Results -->
  <div id="tab-results" class="tab-content" hidden>
    <section id="results-section" class="sim-section">
        <div class="results-header">
            <h2 class="sim-title">Aggregate Results</h2>
        </div>
        <div id="results-empty" class="results-empty">
            Select a type and trace to view aggregate results.
        </div>
        <div id="results-charts" class="results-charts"></div>
    </section>
  </div>

  <!-- Tab: Heatmap & Metrics -->
  <div id="tab-heatmap" class="tab-content" hidden>
    <!-- Simulation 1 -->
    <section id="sim-1" class="sim-section">
      <div class="sim-header">
        <h2 class="sim-title">Simulation 1</h2>
        <button class="heatmap-expand-btn" data-sim="0">Expand</button>
      </div>
      <div id="alloc-bars-1" class="alloc-bars"></div>
      <div class="metrics-bar">
        <div class="metric-col">
          <div class="metric-headline">
            <span class="metric-label">Utilization</span>
            <span id="metric-util-1" class="metric-value">--</span>
          </div>
          <div class="metric-breakdown" id="metric-util-breakdown-1"></div>
        </div>
        <div class="metric-col">
          <div class="metric-headline">
            <span class="metric-label">Running</span>
            <span id="metric-running-1" class="metric-value">--</span>
          </div>
          <div class="metric-breakdown" id="metric-running-breakdown-1"></div>
        </div>
        <div class="metric-col">
          <div class="metric-headline">
            <span class="metric-label">Queued</span>
            <span id="metric-queued-1" class="metric-value">--</span>
          </div>
          <div class="metric-breakdown" id="metric-queued-breakdown-1"></div>
        </div>
        <div class="metric-col">
          <div class="metric-headline">
            <span class="metric-label">Completed</span>
            <span id="metric-completed-1" class="metric-value">--</span>
          </div>
          <div class="metric-sub-row">
            <span class="metric-sub-label">Avg JCT</span>
            <span id="metric-jct-1" class="metric-sub-value">--</span>
          </div>
        </div>
      </div>
      <div class="metrics-bar frag-metrics">
        <div class="metric-col">
          <div class="metric-headline">
            <span class="metric-label">Frag Rate</span>
            <span id="metric-fragrate-1" class="metric-value">--</span>
          </div>
        </div>
        <div class="metric-col">
          <div class="metric-headline">
            <span class="metric-label">Frag/Total</span>
            <span id="metric-fragtotal-1" class="metric-value">--</span>
          </div>
        </div>
        <div class="metric-col">
          <div class="metric-headline">
            <span class="metric-label">Unallocated</span>
            <span id="metric-unalloc-1" class="metric-value">--</span>
          </div>
        </div>
        <div class="metric-col">
          <div class="metric-headline">
            <span class="metric-label">Occupied Nodes</span>
            <span id="metric-nodes-1" class="metric-value">--</span>
          </div>
        </div>
        <div class="metric-col">
          <div class="metric-headline">
            <span class="metric-label">Pending GPUs</span>
            <span id="metric-pending-1" class="metric-value">--</span>
          </div>
          <div class="metric-breakdown" id="metric-pending-breakdown-1"></div>
        </div>
      </div>
    </section>

    <!-- Simulation 2 (initially hidden) -->
    <section id="sim-2" class="sim-section" hidden>
      <div class="sim-header">
        <h2 class="sim-title">Simulation 2</h2>
        <button class="heatmap-expand-btn" data-sim="1">Expand</button>
      </div>
      <div id="alloc-bars-2" class="alloc-bars"></div>
      <div class="metrics-bar">
        <div class="metric-col">
          <div class="metric-headline">
            <span class="metric-label">Utilization</span>
            <span id="metric-util-2" class="metric-value">--</span>
          </div>
          <div class="metric-breakdown" id="metric-util-breakdown-2"></div>
        </div>
        <div class="metric-col">
          <div class="metric-headline">
            <span class="metric-label">Running</span>
            <span id="metric-running-2" class="metric-value">--</span>
          </div>
          <div class="metric-breakdown" id="metric-running-breakdown-2"></div>
        </div>
        <div class="metric-col">
          <div class="metric-headline">
            <span class="metric-label">Queued</span>
            <span id="metric-queued-2" class="metric-value">--</span>
          </div>
          <div class="metric-breakdown" id="metric-queued-breakdown-2"></div>
        </div>
        <div class="metric-col">
          <div class="metric-headline">
            <span class="metric-label">Completed</span>
            <span id="metric-completed-2" class="metric-value">--</span>
          </div>
          <div class="metric-sub-row">
            <span class="metric-sub-label">Avg JCT</span>
            <span id="metric-jct-2" class="metric-sub-value">--</span>
          </div>
        </div>
      </div>
      <div class="metrics-bar frag-metrics">
        <div class="metric-col">
          <div class="metric-headline">
            <span class="metric-label">Frag Rate</span>
            <span id="metric-fragrate-2" class="metric-value">--</span>
          </div>
        </div>
        <div class="metric-col">
          <div class="metric-headline">
            <span class="metric-label">Frag/Total</span>
            <span id="metric-fragtotal-2" class="metric-value">--</span>
          </div>
        </div>
        <div class="metric-col">
          <div class="metric-headline">
            <span class="metric-label">Unallocated</span>
            <span id="metric-unalloc-2" class="metric-value">--</span>
          </div>
        </div>
        <div class="metric-col">
          <div class="metric-headline">
            <span class="metric-label">Occupied Nodes</span>
            <span id="metric-nodes-2" class="metric-value">--</span>
          </div>
        </div>
        <div class="metric-col">
          <div class="metric-headline">
            <span class="metric-label">Pending GPUs</span>
            <span id="metric-pending-2" class="metric-value">--</span>
          </div>
          <div class="metric-breakdown" id="metric-pending-breakdown-2"></div>
        </div>
      </div>
    </section>

    <!-- Queue Panels -->
    <section id="queue-section">
      <div class="queue-panels">
        <div class="queue-panel" id="queue-panel-1">
          <h3>Queue - Simulation 1</h3>
          <ul id="queue-list-1" class="queue-list"></ul>
        </div>
        <div class="queue-panel" id="queue-panel-2">
          <h3>Queue - Simulation 2</h3>
          <ul id="queue-list-2" class="queue-list"></ul>
        </div>
      </div>
    </section>
  </div>

  <!-- Help Modal -->
  <div id="help-modal" class="modal-overlay" hidden>
    <div class="modal-content">
      <button id="modal-close" class="modal-close">&times;</button>
      <h2>About This Visualizer</h2>
      <p>
        This tool visualizes GPU cluster scheduling simulations from
        <a href="https://www.usenix.org/conference/osdi20/presentation/narayanan-deepak" target="_blank" rel="noopener">Gavel</a>
        (Narayanan et al., OSDI 2020). It compares two scheduling policies
        side-by-side, showing how each allocates GPUs to jobs over time.
      </p>

      <h3>What You're Seeing</h3>
      <ul>
        <li><strong>Simulation 1</strong> runs Gavel's heterogeneity-aware policy
          (<code>MaxMinFairness_Perf</code>), which accounts for how different
          job types perform on different GPU types.</li>
        <li><strong>Simulation 2</strong> runs the baseline policy
          (<code>MaxMinFairness</code>), which treats all GPUs as interchangeable.</li>
        <li>Both run the same job trace on a 108-GPU cluster (36 K80 + 36 P100 + 36 V100).</li>
      </ul>

      <h3>GPU Grid</h3>
      <p>
        Each row is a GPU. Color indicates the running job type.
        Black cells are idle. The grid updates as you scrub through time.
      </p>

      <h3>Charts</h3>
      <ul>
        <li><strong>Utilization</strong> -- GPU occupancy (fraction of GPUs in use)
          and effective utilization (throughput-weighted).</li>
        <li><strong>JCT</strong> -- Moving average job completion time (last 100 jobs)
          in hours.</li>
        <li><strong>Queue &amp; Arrivals</strong> -- Number of queued jobs (left axis)
          and job arrival rate (right axis).</li>
        <li><strong>JCT CDF</strong> -- Cumulative distribution of recent job
          completion times. Read as "X% of jobs completed within Y hours."</li>
        <li><strong>Fragmentation</strong> -- FGD paper metrics. "Frag Rate"
          (fragmentation / unallocated GPUs) shows what fraction of idle GPUs
          are stranded on nodes that can't fit any popular task. "Frag/Total"
          normalizes over the full cluster. Requires <code>--gpus-per-node</code>
          in preprocessing for accurate node topology.</li>
        <li><strong>Pending GPU Demand</strong> -- Stacked area chart of queued
          GPU demand broken down by job scale factor (1-GPU, 2-GPU, etc.).</li>
      </ul>

      <h3>Controls</h3>
      <ul>
        <li>Play/pause, step forward/back, jump to start/end.</li>
        <li>Timeline scrubber to jump to any point.</li>
        <li>Keyboard: <kbd>Space</kbd> (play), <kbd>Arrow keys</kbd> (step),
          <kbd>Home</kbd>/<kbd>End</kbd> (jump).</li>
        <li>All/Rolling toggle switches charts between full history and a sliding window.</li>
        <li>Hover any chart for a crosshair tooltip with exact values.</li>
      </ul>

      <h3>Experiment Browser</h3>
      <p>
        Use the tag filters at the top to narrow experiments by trace (Alibaba/Philly),
        policy (Baseline/Gavel/FGD), placement mode, and load level. Select an experiment
        from the dropdown to load it. Both sim slots can be changed independently for
        side-by-side comparison.
      </p>
    </div>
  </div>

  <script type="module" src="src/viz.js"></script>
</body>
</html>
